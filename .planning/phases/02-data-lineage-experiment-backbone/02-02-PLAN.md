---
phase: 02-data-lineage-experiment-backbone
plan: "02"
type: execute
wave: 2
depends_on:
  - "01"
files_modified:
  - scripts/validate_dataset.py
  - scripts/prepare_data.py
  - dvc.yaml
  - tests/test_dataset_validation.py
  - docs/dvc_guide.md
autonomous: true
user_setup: []
must_haves:
  truths:
    - Automated validation fails with non-zero exit code on schema, row-count, or checksum mismatch.
    - `dvc repro` rebuilds phase data artifacts from tracked stages without manual notebook steps.
    - Data preparation outputs are versioned through DVC with explicit dependencies and outputs.
  artifacts:
    - scripts/validate_dataset.py
    - scripts/prepare_data.py
    - dvc.yaml
    - tests/test_dataset_validation.py
    - docs/dvc_guide.md
  key_links:
    - dvc.yaml wires `download_data` output into `validate_data` stage as dependency.
    - scripts/validate_dataset.py compares parquet data to data/contracts/evasionbench_manifest.json.
    - dvc.yaml `prepare_data` stage depends on successful validation and emits tracked outputs.
---

<objective>
Implement fail-fast data validation and reproducible DVC stages for data prep lineage.

Purpose: Satisfy `DATA-02` and `DATA-03` by making data integrity and reproducibility enforceable in the pipeline.
Output: Validation script with tests, expanded DVC stage graph, and updated DVC usage runbook.
</objective>

<execution_context>
@/Users/dustinober/.codex/get-shit-done/workflows/execute-plan.md
@/Users/dustinober/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-lineage-experiment-backbone/02-RESEARCH.md
@.planning/phases/02-data-lineage-experiment-backbone/02-01-SUMMARY.md
@dvc.yaml
@docs/dvc_guide.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build strict dataset validator against manifest contract</name>
  <files>scripts/validate_dataset.py, tests/test_dataset_validation.py</files>
  <action>Create a validator script that checks required columns/types, row count, and checksum against `data/contracts/evasionbench_manifest.json`. Return non-zero exits with actionable error messages when mismatches occur. Add focused tests for success path and each failure mode.</action>
  <verify>`python scripts/validate_dataset.py --data data/raw/evasionbench.parquet --contract data/contracts/evasionbench_manifest.json` returns 0 for matching data and non-zero for injected mismatch fixtures in tests.</verify>
  <done>Data integrity checks are automated, strict, and test-verified.</done>
</task>

<task type="auto">
  <name>Task 2: Expand DVC pipeline into reproducible lineage stages</name>
  <files>dvc.yaml, scripts/prepare_data.py</files>
  <action>Update `dvc.yaml` to include staged lineage (`download_data`, `validate_data`, `prepare_data`) with explicit deps/outs/params. Add `scripts/prepare_data.py` for deterministic preprocessing outputs consumed by later analysis/model phases.</action>
  <verify>`dvc repro` executes full stage chain successfully and regenerates expected artifacts when upstream inputs change.</verify>
  <done>Pipeline lineage is explicit and reproducible through DVC commands.</done>
</task>

<task type="auto">
  <name>Task 3: Document reproducibility contract and validation failure handling</name>
  <files>docs/dvc_guide.md</files>
  <action>Update DVC docs to reflect the staged graph, canonical commands, expected artifacts, and typical validation failures/remediation workflow. Ensure documentation references the actual scripts and stage names implemented in this plan.</action>
  <verify>`rg -n "download_data|validate_data|prepare_data|dvc repro" docs/dvc_guide.md` shows consistent command and stage naming aligned with `dvc.yaml`.</verify>
  <done>Contributors can reproduce and troubleshoot data lineage using documented script-first commands.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python scripts/validate_dataset.py --data data/raw/evasionbench.parquet --contract data/contracts/evasionbench_manifest.json`
- [ ] `pytest -q tests/test_dataset_validation.py`
- [ ] `dvc repro`
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Data validation and DVC reproducibility are operational and documented
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-lineage-experiment-backbone/02-02-SUMMARY.md`
</output>
