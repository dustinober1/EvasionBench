---
phase: 02-data-lineage-experiment-backbone
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/data.py
  - scripts/download_data.py
  - scripts/write_data_manifest.py
  - data/contracts/evasionbench_manifest.json
  - Makefile
  - tests/test_data_lineage_contract.py
autonomous: true
user_setup: []
must_haves:
  truths:
    - A single documented script command downloads and caches EvasionBench deterministically.
    - Downloaded dataset provenance (source revision, checksum, row count, schema) is persisted as machine-readable metadata.
    - Re-running the same command on unchanged inputs yields equivalent data contract outputs.
  artifacts:
    - src/data.py
    - scripts/download_data.py
    - scripts/write_data_manifest.py
    - data/contracts/evasionbench_manifest.json
    - Makefile
    - tests/test_data_lineage_contract.py
  key_links:
    - scripts/download_data.py invokes src/data.py with explicit revision/cache controls.
    - scripts/write_data_manifest.py computes checksum/schema from the downloaded parquet file.
    - tests/test_data_lineage_contract.py verifies deterministic manifest fields and failure behavior.
---

<objective>
Create a deterministic data acquisition foundation with explicit lineage metadata.

Purpose: Satisfy `DATA-01` and provide the contract that all downstream validation/reproducibility depends on.
Output: Canonical download command surface, data manifest generator, and test-backed contract checks.
</objective>

<execution_context>
@/Users/dustinober/.codex/get-shit-done/workflows/execute-plan.md
@/Users/dustinober/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-lineage-experiment-backbone/02-RESEARCH.md
@src/data.py
@scripts/download_data.py
@Makefile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor dataset download for deterministic provenance</name>
  <files>src/data.py, scripts/download_data.py</files>
  <action>Add explicit CLI/config support for dataset source controls (dataset id, split, revision, cache dir, output path) and ensure downloads are deterministic by default. Include clear stdout logging of effective source inputs to aid auditability.</action>
  <verify>`python scripts/download_data.py --output data/raw/evasionbench.parquet --revision <pinned-revision>` succeeds and emits deterministic provenance fields.</verify>
  <done>One script-first command can fetch data deterministically with source revision visible in logs.</done>
</task>

<task type="auto">
  <name>Task 2: Add data manifest writer for schema/row/checksum contract</name>
  <files>scripts/write_data_manifest.py, data/contracts/evasionbench_manifest.json</files>
  <action>Create `scripts/write_data_manifest.py` that reads the parquet artifact and writes machine-readable metadata containing schema, row count, SHA256 checksum, generated timestamp, and source revision. Ensure deterministic ordering/serialization for stable diffs.</action>
  <verify>`python scripts/write_data_manifest.py --data data/raw/evasionbench.parquet --output data/contracts/evasionbench_manifest.json` writes manifest with required keys and stable checksum field.</verify>
  <done>The dataset contract is explicit and persisted in versioned artifacts.</done>
</task>

<task type="auto">
  <name>Task 3: Expose canonical command and regression tests for data contract</name>
  <files>Makefile, tests/test_data_lineage_contract.py</files>
  <action>Add a canonical Make target (for example `make data-fetch`) that runs deterministic download plus manifest generation. Add tests validating manifest shape, checksum generation, and deterministic output expectations for fixed sample inputs.</action>
  <verify>`make data-fetch` completes successfully; `pytest -q tests/test_data_lineage_contract.py` passes with at least one negative assertion for malformed input.</verify>
  <done>Phase data-entry contract is executable and test-backed from script-first entrypoints.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `make data-fetch`
- [ ] `python scripts/write_data_manifest.py --data data/raw/evasionbench.parquet --output data/contracts/evasionbench_manifest.json`
- [ ] `pytest -q tests/test_data_lineage_contract.py`
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Deterministic data acquisition and lineage manifest are operational
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-lineage-experiment-backbone/02-01-SUMMARY.md`
</output>
